#!/usr/bin/perl
#
#
#  A hack to merge pm generated by puic with Perl code
#
#  Gonéri Le Bouder <goneri.lebouder@atosorigin.com>
#
#
use strict;
use warnings;

# TODO: true temp files
my $puic = "/usr/bin/puic";

my ( $inputfile, $codefile, $outputfile ) = @ARGV;

die "param inputfile codefile outputfile" unless ($inputfile && $codefile && $outputfile);
die "$inputfile doesn't exist or can't be read" unless (-f $inputfile);
die "$codefile doesn't exist or can't be read" unless (-f $codefile);


open INPUT, "<$inputfile" or die "Can't open input file";
open TMPOUT, ">/tmp/qsosform_temp.ui" or die "Can't open output file";

print TMPOUT '<!DOCTYPE UI><UI version="3.2" stdsetdef="1">';
my @tmp = <INPUT>;
shift @tmp;
foreach(@tmp) {
	print TMPOUT;
}

close TMPOUT;
close INPUT;


my @perl = `$puic /tmp/qsosform_temp.ui`;

open FINALOUTPUT, ">$outputfile";

my $sub_section;
foreach (@perl) {
unless ($sub_section) {
	if (/^sub\ fileNew/) { # Change this !
		$sub_section = 1;
	} else {
		print FINALOUTPUT;
	}
	}
}

print FINALOUTPUT "#### Code section\n";

open CODE, "<$codefile" or die;

print FINALOUTPUT foreach (<CODE>);
close CODE;

close FINALOUTPUT;
